/**
 * 
 */
package com.test.utils;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.List;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import org.apache.commons.io.FileUtils;
import org.w3c.dom.Document;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

/**
 * Contains methods to generate detailed report for Appium tests using TestNG
 * 
 * @author Ashraf Iftekhar, Mar 27, 2017
 *
 */
public class Reporting {

	static String pass, fail, skip, ignore, total;
	static String Tester = "--", project = "--", platform = "--", device = "--",
			Notes = "Notes are not added for this report";

	static String path = System.getProperty("user.dir") + "/test-output/testng-results.xml";
	static File xml = new File(path);

	static char quote = '"';
	static String methodName, status, style;
	static String testrow, fullData = "";
	static int num = 0;
	static List<String> FormViewData = new ArrayList<String>();

	static List<String[]> ArrList = new ArrayList<String[]>();

	/**
	 * generates complete report in HTML format according to the provided
	 * Template, The Template is fixed and please contact
	 * <a href="ashraf.iftekhar@mutualmobile.com">Ashraf Iftekhar</a> for the
	 * template file
	 * 
	 * @param TemplatePath
	 *            path of the Template file
	 * @param NewReportName
	 *            Name of report you want to create
	 * @throws ParserConfigurationException
	 * @throws SAXException
	 * @throws IOException
	 * 
	 * @author md.ashrafiftekhar
	 */
	public static void generate(String TemplatePath, String NewReportName)
			throws ParserConfigurationException, SAXException, IOException {
		parseXML();
		System.out.println("xmlParsed");
		writeToHTML(TemplatePath, NewReportName);
		System.out.println("done");
	}

	/**
	 * Internal method to parse the testng-results.xml file
	 * 
	 * @throws ParserConfigurationException
	 * @throws SAXException
	 * @throws IOException
	 */
	public static void parseXML() throws ParserConfigurationException, SAXException, IOException {
		DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
		DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
		Document doc = dBuilder.parse(xml);
		doc.getDocumentElement().normalize();
		NodeList ResultList = doc.getElementsByTagName("testng-results");
		NodeList MethodList = doc.getElementsByTagName("test-method");

		for (int i = 0; i < ResultList.getLength(); i++) {

			NamedNodeMap attributes = ResultList.item(i).getAttributes();
			pass = attributes.getNamedItem("passed").getNodeValue();
			fail = attributes.getNamedItem("failed").getNodeValue();
			skip = attributes.getNamedItem("skipped").getNodeValue();
			ignore = attributes.getNamedItem("ignored").getNodeValue();
			total = attributes.getNamedItem("total").getNodeValue();

		}
		for (int i = 0; i < MethodList.getLength(); i++) {
			if (MethodList.item(i).getAttributes().getNamedItem("name").getNodeValue() == MethodList.item(i - 1)
					.getAttributes().getNamedItem("name").getNodeValue()) {

			}
			String[] TestDetails = new String[3];
			NamedNodeMap attributes = MethodList.item(i).getAttributes();
			TestDetails[0] = attributes.getNamedItem("name").getNodeValue();
			TestDetails[1] = attributes.getNamedItem("status").getNodeValue();
			if (TestDetails[1].equals("FAIL")) {
				TestDetails[2] = "Style=" + quote + "color:red" + quote;
			} else if (TestDetails[1].equals("PASS")) {
				TestDetails[2] = "Style=" + quote + "color:green" + quote;
			} else if (TestDetails[1].equals("IGNORE")) {
				TestDetails[2] = "Style=" + quote + "color:blue" + quote;
			} else if (TestDetails[1].equals("SKIP")) {
				TestDetails[2] = "Style=" + quote + "color:orange" + quote;
			}

			ArrList.add(TestDetails);
		}
	}

	/**
	 * Writes HTML file after all the values are generated
	 * 
	 * @param TemplatePath
	 * @param ReportName
	 * 
	 * @throws IOException
	 */
	public static void writeToHTML(String TemplatePath, String ReportName) throws IOException {
		java.util.Date date = new java.util.Date();
		SimpleDateFormat ft = new SimpleDateFormat("E yyyy.MM.dd 'at' hh:mm:ss a zzz");
		File htmlTemplateFile = new File(TemplatePath);
		String htmlString = FileUtils.readFileToString(htmlTemplateFile);
		htmlString = htmlString.replace("$Heading", "TestReport");

		htmlString = htmlString.replace("$P", pass);
		htmlString = htmlString.replace("$F", fail);
		htmlString = htmlString.replace("$S", skip);
		htmlString = htmlString.replace("$I", ignore);
		htmlString = htmlString.replace("$T", total);

		htmlString = htmlString.replace("$Tester", Tester);
		htmlString = htmlString.replace("$Date", ft.format(date));
		htmlString = htmlString.replace("$Project", project);
		htmlString = htmlString.replace("$Platform", platform);
		htmlString = htmlString.replace("$Device", device);

		htmlString = htmlString.replace("$Notes", Notes);

		for (String[] S : ArrList) {

			methodName = S[0];
			status = S[1];
			style = S[2];
			num = num + 1;
			testrow = "<tr class=" + quote + "test" + quote + "><td width=" + quote + "70" + quote + ">" + num
					+ "</td><td width=" + quote + 1000 + quote + ">" + methodName + "</td><td width=" + quote + 200
					+ quote + style + ">" + status + "</td></tr>";
			fullData = fullData + testrow;

		}

		htmlString = htmlString.replace("$myrows", fullData);

		File newHtmlFile = new File(System.getProperty("user.dir") + "/" + ReportName + ".html");
		FileUtils.writeStringToFile(newHtmlFile, htmlString);
		System.out.println("file written");

	}

	/**
	 * This method should be called before Reporting.generate() method to add
	 * specific info in your report
	 * 
	 * @param TesterName
	 *            Tester Name
	 * @param Project
	 *            Project in test or Application Under Test
	 * @param platform
	 *            Platform in test
	 * @param device
	 *            Test Device
	 * 
	 * @author md.ashrafiftekhar
	 */
	public static void addTestDetails(String TesterName, String Project, String platform, String device) {
		Tester = TesterName;
		project = Project;
		Reporting.platform = platform;
		Reporting.device = device;
	}

	/**
	 * This method should be called before Reporting.generate() method to add
	 * notes
	 * 
	 * @param Notes
	 * 
	 * @author md.ashrafiftekhar
	 */
	public static void AddTesterNotes(String Notes) {
		Reporting.Notes = Notes;
	}

}
